<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Category Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-gray-100">
    <div class="flex h-screen">
      <%- include('../partials/admin/sidebar') %>

      <main class="flex-1 overflow-y-auto">
        <%- include('../partials/admin/header') %>

        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold text-gray-800">
              Category Management
            </h1>

            <div class="flex gap-4 items-center">
              <form method="get" class="flex gap-2">
                <input
                  type="text"
                  name="search"
                  id="searchInput"
                  value="<%= typeof search !== 'undefined' ? search : '' %>"
                  placeholder="Search categories..."
                  class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64"
                />

                <button
                  type="submit"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
                >
                  Search
                </button>

                <% if (typeof search !== 'undefined' && search.length > 0) { %>
                <a
                  href="/admin/category"
                  class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition font-medium flex items-center"
                >
                  Clear
                </a>
                <% } %>
              </form>

              <button
                id="addCategoryBtn"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium flex items-center"
              >
                <i class="fas fa-plus mr-2"></i> Add Category
              </button>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full min-w-max">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Name
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Description
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>

                <tbody class="bg-white divide-y divide-gray-200">
                  <% if (categories && categories.length > 0) { %> 
                    <% categories.forEach(category => { %>
                    <tr class="hover:bg-gray-50 transition" data-id="<%= category._id %>">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                          <%= category.name %>
                        </div>
                      </td>

                      <td class="px-6 py-4">
                        <div class="text-sm text-gray-600 max-w-xs truncate">
                          <%= category.description || "—" %>
                        </div>
                      </td>

                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium 
                          <%= category.isListed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                          <%= category.isListed ? "Listed" : "Unlisted" %>
                        </span>
                      </td>

                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                          <% if (category.isListed) { %>
                          <button
                            class="unlist-btn text-orange-600 hover:text-orange-900 transition"
                            title="Unlist"
                          >
                            <i class="fas fa-eye-slash"></i>
                          </button>
                          <% } else { %>
                          <button
                            class="list-btn text-green-600 hover:text-green-900 transition"
                            title="List"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                          <% } %>

                          <button
                            class="edit-btn text-blue-600 hover:text-blue-900 transition"
                            title="Edit"
                          >
                            <i class="fas fa-edit"></i>
                          </button>

                          <button
                            class="delete-btn text-red-600 hover:text-red-900 transition"
                            title="Delete"
                          >
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <% }) %> 
                  <% } else { %>
                    <tr>
                      <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                          <i class="fas fa-folder-open text-4xl text-gray-300 mb-2"></i>
                          <p class="text-lg font-medium">No categories found</p>
                          <p class="text-sm">Get started by adding your first category</p>
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>

            <% if (totalPages > 1) { %>
            <div class="flex items-center justify-between px-6 py-4 border-t bg-white">
              <span class="text-sm text-gray-700">
                Page <%= currentPage %> of <%= totalPages %> — Total: <%= totalCategories %> categories
              </span>

              <div class="flex space-x-2">
                <% if (currentPage > 1) { %>
                  <a href="?page=<%= currentPage - 1 %><% if (search) { %>&search=<%= search %><% } %>"
                     class="w-8 h-8 flex items-center justify-center border rounded hover:bg-gray-100 transition">
                     <i class="fas fa-chevron-left text-gray-600"></i>
                  </a>
                <% } else { %>
                  <span class="w-8 h-8 flex items-center justify-center border rounded opacity-50 cursor-not-allowed">
                    <i class="fas fa-chevron-left text-gray-400"></i>
                  </span>
                <% } %>

                <% for(let i = 1; i <= totalPages; i++) { %>
                  <% if (i === currentPage) { %>
                    <span class="w-8 h-8 flex items-center justify-center rounded text-sm font-medium bg-blue-500 text-white">
                      <%= i %>
                    </span>
                  <% } else { %>
                    <a href="?page=<%= i %><% if (search) { %>&search=<%= search %><% } %>"
                       class="w-8 h-8 flex items-center justify-center rounded text-sm font-medium text-gray-700 border hover:bg-gray-100 transition">
                      <%= i %>
                    </a>
                  <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                  <a href="?page=<%= currentPage + 1 %><% if (search) { %>&search=<%= search %><% } %>"
                     class="w-8 h-8 flex items-center justify-center border rounded hover:bg-gray-100 transition">
                     <i class="fas fa-chevron-right text-gray-600"></i>
                  </a>
                <% } else { %>
                  <span class="w-8 h-8 flex items-center justify-center border rounded opacity-50 cursor-not-allowed">
                    <i class="fas fa-chevron-right text-gray-400"></i>
                  </span>
                <% } %>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </main>
    </div>

    <div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-800" id="modalTitle">Add Category</h2>
          <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="p-6">
          <form id="addCategoryForm">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
              <input
                type="text"
                name="name"
                required
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Enter category name"
              />
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
              <textarea
                name="description"
                rows="3"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Enter category description (optional)"
              ></textarea>
            </div>

            <div class="flex justify-end space-x-4">
              <button
                type="button"
                id="cancelAddCategory"
                class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-medium"
              >
                Cancel
              </button>

              <button
                type="submit"
                id="submitBtn"
                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-medium flex items-center"
              >
                <i class="fas fa-save mr-2"></i> Save Category
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const addBtn = document.getElementById("addCategoryBtn");
      const addModal = document.getElementById("addCategoryModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const cancelAdd = document.getElementById("cancelAddCategory");
      const addForm = document.getElementById("addCategoryForm");
      const modalTitle = document.getElementById("modalTitle");
      const submitBtn = document.getElementById("submitBtn");
      const table = document.querySelector("table");

      let editingId = null;

      function openModal(isEdit = false, cat = {}) {
        editingId = isEdit ? cat._id : null;

        modalTitle.innerText = isEdit ? "Edit Category" : "Add Category";
        submitBtn.innerHTML = isEdit 
          ? '<i class="fas fa-save mr-2"></i> Update Category' 
          : '<i class="fas fa-save mr-2"></i> Save Category';

        addForm.name.value = cat.name || "";
        addForm.description.value = cat.description || "";

        addModal.classList.remove("hidden");
        addModal.classList.add("flex");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        addModal.classList.remove("flex");
        addModal.classList.add("hidden");
        document.body.style.overflow = "";
        addForm.reset();
        editingId = null;
      }

      addBtn.addEventListener("click", () => openModal(false));
      closeModalBtn.addEventListener("click", closeModal);
      cancelAdd.addEventListener("click", closeModal);

      addModal.addEventListener("click", (e) => {
        if (e.target === addModal) {
          closeModal();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && addModal.classList.contains("flex")) {
          closeModal();
        }
      });

      addForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const submitBtn = addForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

        const data = Object.fromEntries(new FormData(addForm));

        try {
          let res;
          if (editingId) {
            res = await axios.put(`/admin/editCategory/${editingId}`, data);
          } else {
            res = await axios.post(`/admin/addCategory`, data);
          }

          alert(res.data.message || "Operation successful!");
          closeModal();
          location.reload();
        } catch (err) {
          alert(err.response?.data?.message || "Operation failed!");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      table.addEventListener("click", async (e) => {
        const btn = e.target.closest(".delete-btn");
        if (!btn) return;

        if (!confirm("Are you sure you want to delete this category?")) return;

        const id = btn.closest("tr").dataset.id;

        try {
          await axios.delete(`/admin/deleteCategory/${id}`);
          alert("Category deleted successfully!");
          location.reload();
        } catch (err) {
          alert("Failed to delete category!");
        }
      });

      table.addEventListener("click", async (e) => {
        const btn = e.target.closest(".list-btn, .unlist-btn");
        if (!btn) return;

        const id = btn.closest("tr").dataset.id;
        const action = btn.classList.contains("list-btn") ? "list" : "unlist";
        const confirmMessage = action === "list" 
          ? "Are you sure you want to list this category?" 
          : "Are you sure you want to unlist this category?";

        if (!confirm(confirmMessage)) return;

        const url = action === "list" 
          ? `/admin/listCategory/${id}`
          : `/admin/unlistCategory/${id}`;

        try {
          const { data } = await axios.patch(url);
          alert(data.message || "Operation successful!");
          location.reload();
        } catch (err) {
          alert("Operation failed!");
        }
      });

      table.addEventListener("click", (e) => {
        const btn = e.target.closest(".edit-btn");
        if (!btn) return;

        const row = btn.closest("tr");
        const name = row.cells[0].textContent.trim();
        const description = row.cells[1].textContent.trim();

        const cat = {
          _id: row.dataset.id,
          name: name,
          description: description === "—" ? "" : description
        };

        openModal(true, cat);
      });
    </script>
  </body>
</html>