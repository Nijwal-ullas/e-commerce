<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - RnBB Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .submenu.open {
        max-height: 200px;
      }
      .date-inputs {
        display: none;
      }
      .date-inputs.show {
        display: flex;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
      <%- include('../partials/admin/sidebar') %>

      <div class="flex-1 overflow-auto">
        <%- include('../partials/admin/header') %>

        <div class="p-6">
          <!-- Welcome Banner -->
          <div
            class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-8 text-white mb-6"
          >
            <div class="flex justify-between items-center">
              <div>
                <h1 class="text-3xl font-bold mb-2">
                  Welcome back, <%= adminName || 'Admin' %>!
                </h1>
                <p class="text-sm opacity-90 mb-4">
                  Here's your business overview for today
                </p>
              </div>
              <div class="hidden md:block">
                <i class="fas fa-chart-line text-8xl opacity-20"></i>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <!-- Total Orders -->
            <div
              class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Sales Count</p>
                  <h2 id="salesCount" class="text-3xl font-bold text-gray-800">0</h2>
                  <p class="text-xs text-green-600 mt-2">
                    <i class="fas fa-arrow-up mr-1"></i>Active
                  </p>
                </div>
                <div class="bg-indigo-100 rounded-full p-4">
                  <i class="fas fa-shopping-bag text-indigo-600 text-2xl"></i>
                </div>
              </div>
            </div>

            <!-- Total Sales -->
            <div
              class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Total Sales Amount</p>
                  <h2 id="totalSalesAmount" class="text-3xl font-bold text-gray-800">₹0.00</h2>
                  <p class="text-xs text-green-600 mt-2">
                    <i class="fas fa-arrow-up mr-1"></i>Revenue
                  </p>
                </div>
                <div class="bg-green-100 rounded-full p-4">
                  <i class="fas fa-rupee-sign text-green-600 text-2xl"></i>
                </div>
              </div>
            </div>

            <!-- Product Discount -->
            <div
              class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Product Discount</p>
                  <h2 id="productDiscount" class="text-3xl font-bold text-orange-600">₹0.00</h2>
                  <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-tag mr-1"></i>Offers
                  </p>
                </div>
                <div class="bg-orange-100 rounded-full p-4">
                  <i class="fas fa-tags text-orange-600 text-2xl"></i>
                </div>
              </div>
            </div>

            <!-- Coupon Discount -->
            <div
              class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Coupon Discount</p>
                  <h2 id="couponDiscount" class="text-3xl font-bold text-red-600">₹0.00</h2>
                  <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-ticket-alt mr-1"></i>Coupons
                  </p>
                </div>
                <div class="bg-red-100 rounded-full p-4">
                  <i class="fas fa-ticket-alt text-red-600 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Sales Chart -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <div class="flex flex-col gap-3 mb-4">
                <div class="flex justify-between items-center">
                  <h3 class="text-lg font-semibold text-gray-800">
                    Sales Overview
                  </h3>
                  <select id="reportType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="day">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>

                <!-- Custom Date Inputs (Hidden by default) -->
                <div id="dateInputs" class="date-inputs gap-3 items-center">
                  <div class="flex-1">
                    <label class="block text-sm text-gray-600 mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm text-gray-600 mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  </div>
                </div>
              </div>

              <canvas id="salesChart"></canvas>

              <div class="flex gap-3 mt-4">
                <button
                  id="downloadExcel"
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                  <i class="fas fa-file-excel mr-1"></i> Excel
                </button>

                <button
                  id="downloadPdf"
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                  <i class="fas fa-file-pdf mr-1"></i> PDF
                </button>
              </div>
            </div>

            <!-- Order Status Chart -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                Order Status
              </h3>
              <canvas id="orderStatusChart"></canvas>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Products -->
            <div
              class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-md"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-90 mb-1">Total Products</p>
                  <h2 class="text-3xl font-bold"><%= totalProducts || 0 %></h2>
                </div>
                <i class="fas fa-box text-5xl opacity-30"></i>
              </div>
            </div>

            <!-- Total Users -->
            <div
              class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-md"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-90 mb-1">Total Users</p>
                  <h2 class="text-3xl font-bold"><%= totalUsers || 0 %></h2>
                </div>
                <i class="fas fa-users text-5xl opacity-30"></i>
              </div>
            </div>

            <!-- Active Coupons -->
            <div
              class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-xl p-6 text-white shadow-md"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-90 mb-1">Active Coupons</p>
                  <h2 class="text-3xl font-bold"><%= activeCoupons || 0 %></h2>
                </div>
                <i class="fas fa-gift text-5xl opacity-30"></i>
              </div>
            </div>
          </div>

          <!-- Recent Orders & Top Categories Side by Side -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Recent Orders -->
            <div class="bg-white rounded-xl p-6 shadow-md">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Recent Orders</h3>
                <a href="/admin/adminOrders"
                  class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                  View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
              </div>
              <div class="space-y-3">
                <% if (recentOrders && recentOrders.length > 0) { %> 
                  <% recentOrders.slice(0, 5).forEach(order => { %>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                      <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 rounded-full p-2">
                          <i class="fas fa-receipt text-indigo-600"></i>
                        </div>
                        <div>
                          <p class="font-medium text-gray-800">#<%= order.orderId %></p>
                          <p class="text-xs text-gray-500"><%= order.userName || 'Customer' %></p>
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="font-semibold text-gray-800">₹<%= order.totalAmount?.toFixed(2) %></p>
                        <span class="inline-block px-2 py-1 text-xs rounded-full <%= order.status === 'Delivered' ? 'bg-green-100 text-green-800' : order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800' %>">
                          <%= order.status %>
                        </span>
                      </div>
                    </div>
                  <% }) %> 
                <% } else { %>
                  <p class="text-center text-gray-500 py-8">No recent orders</p>
                <% } %>
              </div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Top Selling Products</h3>
                <a href="/admin/product"
                  class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                  View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
              </div>
              <div class="space-y-3">
               <% if (topProducts && topProducts.length > 0) { %>

  <% topProducts.forEach((product, index) => { %>
    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
      
      <div class="flex items-center gap-3">
        <div class="bg-orange-100 rounded-full w-10 h-10 flex items-center justify-center">
          <span class="text-orange-600 font-bold text-sm">
            #<%= index + 1 %>
          </span>
        </div>

        

        <div>
          <p class="font-medium text-gray-800">
            <%= product.name %>
          </p>
          <p class="text-xs text-gray-500">
            Sold: <%= product.sold %>
          </p>
        </div>
      </div>

      <div class="text-right">
        <p class="font-semibold text-gray-800">
          ₹<%= product.totalRevenue.toFixed(2) %>
        </p>
        <p class="text-xs text-gray-500">Revenue</p>
      </div>
    </div>
  <% }) %>

<% } else { %>
  <p class="text-center text-gray-500 py-8">
    No products data available
  </p>
<% } %>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function toggleDropdown(subId, chevronId) {
        const sub = document.getElementById(subId);
        const chevron = document.getElementById(chevronId);
        sub.classList.toggle("open");
        chevron.classList.toggle("rotate-180");
      }

      let salesChart;

      const reportType = document.getElementById("reportType");
      const startDate = document.getElementById("startDate");
      const endDate = document.getElementById("endDate");
      const dateInputs = document.getElementById("dateInputs");

      function toggleDateInputs() {
        if (reportType.value === "custom") {
          dateInputs.classList.add("show");
        } else {
          dateInputs.classList.remove("show");
        }
      }

      async function loadReport() {
        const type = reportType.value;
        let url = `/admin/sales-report?type=${type}`;

        if (type === "custom") {
          if (!startDate.value || !endDate.value) return;
          url += `&startDate=${startDate.value}&endDate=${endDate.value}`;
        }

        const res = await fetch(url);
        const result = await res.json();
        if (!result.success) return;

        updateDashboardCards(result.summary);
        renderChart(result.data);
      }

      function updateDashboardCards(summary) {
        document.getElementById("salesCount").textContent =
          summary.salesCount || 0;

        document.getElementById("totalSalesAmount").textContent =
          "₹" + (summary.totalSalesAmount || 0).toFixed(2);

        document.getElementById("productDiscount").textContent =
          "₹" + (summary.productDiscount || 0).toFixed(2);

        document.getElementById("couponDiscount").textContent =
          "₹" + (summary.couponDiscount || 0).toFixed(2);
      }

      function renderChart(data) {
        const labels = data.map(item => item._id);
        const sales = data.map(item => item.netSales);
        const orders = data.map(item => item.orderCount);

        const ctx = document.getElementById("salesChart").getContext("2d");

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Net Sales (₹)",
                data: sales,
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79,70,229,0.15)",
                fill: true,
                tension: 0.4,
                pointRadius: 5
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const i = ctx.dataIndex;
                    return [
                      `Sales: ₹${sales[i]}`,
                      `Orders: ${orders[i]}`
                    ];
                  }
                }
              },
              legend: { position: "bottom" }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      reportType.addEventListener("change", () => {
        toggleDateInputs();
        loadReport();
      });
      
      startDate.addEventListener("change", loadReport);
      endDate.addEventListener("change", loadReport);

      toggleDateInputs();
      loadReport();

      document.getElementById("downloadExcel").addEventListener("click", () => {
        const type = reportType.value;
        let url = `/admin/sales-report/excel?type=${type}`;

        if (type === "custom") {
          if (!startDate.value || !endDate.value) return alert("Select dates");
          url += `&startDate=${startDate.value}&endDate=${endDate.value}`;
        }

        window.location.href = url;
      });

      document.getElementById("downloadPdf").addEventListener("click", () => {
        const type = reportType.value;
        let url = `/admin/sales-report/pdf?type=${type}`;

        if (type === "custom") {
          if (!startDate.value || !endDate.value) return alert("Select dates");
          url += `&startDate=${startDate.value}&endDate=${endDate.value}`;
        }

        window.location.href = url;
      });

      let orderStatusChart;

      async function loadOrderStatusChart() {
        const res = await fetch("/admin/order-status-report");
        const result = await res.json();

        if (!result.success) return;

        const labels = result.data.map((item) => item.status || "Unknown");
        const counts = result.data.map((item) => item.count);

        const ctx = document
          .getElementById("orderStatusChart")
          .getContext("2d");

        if (orderStatusChart) orderStatusChart.destroy();

        orderStatusChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [
              {
                data: counts,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      loadOrderStatusChart();
    </script>
  </body>
</html>