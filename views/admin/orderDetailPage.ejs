<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .status-select:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
      }
      .cancelled-order {
        opacity: 0.7;
        position: relative;
      }
      .cancelled-order::after {
        content: "CANCELLED";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 3rem;
        font-weight: bold;
        color: rgba(239, 68, 68, 0.2);
        z-index: 10;
        pointer-events: none;
      }
      .item-status-badge {
        min-width: 100px;
        text-align: center;
      }
      .action-btn {
        min-width: 100px;
      }
      .return-request-row {
        background-color: rgba(255, 251, 235, 0.5);
        border-left: 3px solid #f59e0b;
      }
      .return-approved-row {
        background-color: rgba(236, 253, 245, 0.5);
        border-left: 3px solid #10b981;
      }
      .returned-row {
        background-color: rgba(245, 243, 255, 0.5);
        border-left: 3px solid #8b5cf6;
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <div class="flex h-screen">
      <%- include('../partials/admin/sidebar') %>

      <main class="flex-1 overflow-y-auto">
        <%- include('../partials/admin/header') %>

        <div
          class="p-6 <%= order.orderStatus === 'Cancelled' ? 'cancelled-order' : '' %>"
        >
          <div class="mb-4">
            <a
              href="/admin/adminOrders"
              class="inline-flex items-center text-gray-600 hover:text-gray-800"
            >
              <i class="fas fa-arrow-left mr-2"></i>
              Back to Orders
            </a>
          </div>

          <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-start">
              <div>
                <h1 class="text-2xl font-semibold text-gray-800 mb-2">
                  Order Details: <%= order.orderId %>
                </h1>
                <p class="text-sm text-gray-500">
                  <%= new Date(order.createdAt).toLocaleString('en-US', { month:
                  'short', day: 'numeric', year: 'numeric', hour: 'numeric',
                  minute: '2-digit', hour12: true }) %>
                </p>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right">
                  <span class="text-sm text-gray-600 block mb-1"
                    >Order Status:</span
                  >
                  <div class="flex items-center gap-2">
                    <span
                      id="orderStatusBadge"
                      class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= order.orderStatus === 'Delivered' ? 'bg-green-100 text-green-800' : order.orderStatus === 'Shipped' ? 'bg-blue-100 text-blue-800' : order.orderStatus === 'Processing' ? 'bg-indigo-100 text-indigo-800' : order.orderStatus === 'Cancelled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %>"
                    >
                      <%= order.orderStatus %> 
                      <% if (order.orderStatus === 'Delivered' && order.deliveredDate) { %>
                        <i class="fas fa-check ml-2"></i>
                      <% } %>
                    </span>
                    
                    <!-- <% if (order.orderStatus !== 'Cancelled' && order.orderStatus !== 'Delivered') { %>
                      <select
                        id="orderStatusSelect"
                        class="status-select px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-400"
                        data-order-id="<%= order._id %>"
                        data-current-status="<%= order.orderStatus %>"
                      ></select>
                    <% } else if (order.orderStatus === 'Delivered') { %>
                      <span class="text-sm text-gray-500 italic">(Delivered)</span>
                    <% } else { %>
                      <span class="text-sm text-gray-500 italic">(Cancelled)</span>
                    <% } %> -->
                  </div>
                </div>
              </div>
            </div>

            <% if (order.orderStatus === 'Cancelled') { %>
              <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded">
                <div class="flex items-start">
                  <i class="fas fa-ban text-red-500 mt-1 mr-2"></i>
                  <div>
                    <p class="text-sm text-red-700 font-medium">
                      This order has been cancelled by the customer.
                    </p>
                    <p class="text-xs text-red-600 mt-1">
                      No further status updates are allowed for cancelled orders.
                    </p>
                  </div>
                </div>
              </div>
            <% } %>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-6">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">
                Customer Information
              </h2>
              <div class="space-y-2 text-sm text-gray-600">
                <% if (order.userId) { %>
                  <p class="font-medium text-gray-800"><%= order.userId.name %></p>
                  <p>
                    <span class="text-gray-500">Email:</span>
                    <a
                      href="mailto:<%= order.userId.email %>"
                      class="text-blue-600 hover:underline"
                    >
                      <%= order.userId.email %>
                    </a>
                  </p>
                  <% if (order.userId.phone) { %>
                    <p>
                      <span class="text-gray-500">Phone:</span>
                      <a
                        href="tel:<%= order.userId.phone %>"
                        class="text-blue-600 hover:underline"
                      >
                        <%= order.userId.phone %>
                      </a>
                    </p>
                  <% } %>
                <% } else { %>
                  <p class="text-gray-500">Customer information not available</p>
                <% } %>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">
                Order Summary
              </h2>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Order ID:</span>
                  <span class="font-medium text-gray-800"><%= order.orderId %></span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-600">Original Amount:</span>
                  <span class="font-semibold text-gray-800">
                    â‚¹<%= Number(order.totalPrice || 0).toFixed(2) %>
                  </span>
                </div>
                
                <% if (order.discount && order.discount > 0) { %>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Discount:</span>
                    <span class="font-semibold text-green-600">
                      -â‚¹<%= Number(order.discount || 0).toFixed(2) %>
                    </span>
                  </div>
                <% } %>
                
                <div class="flex justify-between">
                  <span class="text-gray-600">Final Amount:</span>
                  <span class="font-bold text-gray-900">
                    â‚¹<%= Number(order.finalAmount || 0).toFixed(2) %>
                  </span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-600">Payment Method:</span>
                  <span class="font-medium text-gray-800"><%= order.payment %></span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-gray-600">Payment Status:</span>
                  <span class="font-medium <%= order.paymentStatus === 'Paid' ? 'text-green-600' : order.paymentStatus === 'Pending' ? 'text-yellow-600' : order.paymentStatus === 'Refunded' ? 'text-purple-600' : 'text-red-600' %>">
                    <%= order.paymentStatus %>
                  </span>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">
                Shipping Address
              </h2>
              <% if (order.shippingAddress && order.shippingAddress.length > 0) { 
                const address = order.shippingAddress[0]; 
              %>
                <div class="space-y-2 text-sm text-gray-600">
                  <% if (address.name) { %>
                    <p class="font-medium text-gray-800"><%= address.name %></p>
                  <% } %>
                  <p><%= address.flatNumber %>, <%= address.streetName %></p>
                  <% if (address.landmark) { %>
                    <p>Landmark: <%= address.landmark %></p>
                  <% } %>
                  <p><%= address.city %>, <%= address.state %></p>
                  <p><%= address.country %> - <%= address.pincode %></p>
                  <p class="pt-2">
                    <span class="text-gray-500">Phone:</span>
                    <a
                      href="tel:<%= address.phone %>"
                      class="text-blue-600 hover:underline"
                    >
                      <%= address.phone %>
                    </a>
                  </p>
                  <% if (address.alterPhone) { %>
                    <p>
                      <span class="text-gray-500">Alt Phone:</span>
                      <a
                        href="tel:<%= address.alterPhone %>"
                        class="text-blue-600 hover:underline"
                      >
                        <%= address.alterPhone %>
                      </a>
                    </p>
                  <% } %>
                </div>
              <% } else { %>
                <p class="text-gray-500">Shipping address not available</p>
              <% } %>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Image</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Size</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Quantity</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Price</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Payment Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Return Reason</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <% if (order.orderedItem && order.orderedItem.length > 0) { 
                    order.orderedItem.forEach((item, index) => { 
                      const itemStatus = item.status || order.orderStatus || 'Pending';
                      const itemStatusLower = itemStatus.toLowerCase();
                      const itemPaymentStatus = item.paymentStatus || 'Pending';
                      const itemPaymentStatusLower = itemPaymentStatus.toLowerCase();
                      const isFinalState = ['cancelled', 'returned', 'return approved'].includes(itemStatusLower);
                      let rowClass = '';
                      
                      if (itemStatusLower === 'return requested') {
                        rowClass = 'return-request-row';
                      } else if (itemStatusLower === 'return approved') {
                        rowClass = 'return-approved-row';
                      } else if (itemStatusLower === 'returned') {
                        rowClass = 'returned-row';
                      }
                      
                      const canApproveReturn = itemStatus === 'Return Requested';
                      const canRejectReturn = itemStatus === 'Return Requested';
                      const canRefund = itemStatus === 'Return Approved' && itemPaymentStatus !== 'Refunded';
                      
                      let productName = 'Product';
                      let productImages = [];
                      
                      if (item.productId) {
                        if (typeof item.productId === 'object') {
                          productName = item.productId.productName || item.productId.name || 'Product';
                          productImages = item.productId.images || [];
                        } else {
                          productName = 'Product ID: ' + item.productId;
                        }
                      }
                  %>
                  <tr
                    data-item-id="<%= item._id %>"
                    class="<%= rowClass %> <%= item.status === 'Cancelled' ? 'bg-gray-50' : '' %>"
                  >
                    <td class="px-6 py-4 text-sm text-gray-800">
                      <%= productName %>
                      <% if (item.productId && typeof item.productId === 'object' && item.productId.brand) { %>
                        <span class="text-xs text-gray-500 block">Brand: <%= item.productId.brand.name %></span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <% if (productImages.length > 0) { %>
                        <img
                          src="<%= productImages[0] %>"
                          alt="<%= productName %>"
                          class="w-12 h-12 object-cover rounded mx-auto"
                          onerror="this.src='/images/placeholder.png'"
                        />
                      <% } else { %>
                        <div class="w-12 h-12 bg-gray-200 rounded mx-auto flex items-center justify-center">
                          <i class="fas fa-image text-gray-400"></i>
                        </div>
                      <% } %>
                    </td>
                    <td class="px-6 py-4 text-center text-sm text-gray-600">
                      <%= item.ml || 'N/A' %>ml
                    </td>
                    <td class="px-6 py-4 text-center text-sm text-gray-600">
                      <%= item.quantity %>
                    </td>
                    <td class="px-6 py-4 text-center text-sm text-gray-800">
                      â‚¹<%= Number(item.price || 0).toFixed(2) %>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <% if (isFinalState) { %>
                        <span
                          class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium item-status-badge 
                          <%= itemStatusLower === 'delivered' ? 'bg-green-100 text-green-800' : 
                            itemStatusLower === 'shipped' ? 'bg-blue-100 text-blue-800' : 
                            itemStatusLower === 'processing' ? 'bg-indigo-100 text-indigo-800' : 
                            itemStatusLower === 'cancelled' ? 'bg-red-100 text-red-800' : 
                            itemStatusLower === 'returned' ? 'bg-purple-100 text-purple-800' : 
                            itemStatusLower === 'return requested' ? 'bg-yellow-100 text-yellow-800' : 
                            itemStatusLower === 'return approved' ? 'bg-blue-100 text-blue-800' : 
                            'bg-yellow-100 text-yellow-800' %>"
                        >
                          <%= itemStatus %>
                          <% if (itemStatusLower === 'delivered' && item.deliveredDate) { %>
                            <i class="fas fa-check ml-1"></i>
                          <% } %>
                        </span>
                      <% } else { %>
                        <select
                          data-item-id="<%= item._id %>"
                          data-order-id="<%= order._id %>"
                          data-current-status="<%= itemStatus %>"
                          class="item-status-select px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-400 w-full max-w-xs"
                        ></select>
                      <% } %>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <% 
                        let paymentBadgeClass = 'bg-gray-100 text-gray-800';
                        let paymentIcon = 'fa-clock';
                        
                        if (itemPaymentStatusLower === 'paid') {
                          paymentBadgeClass = 'bg-green-100 text-green-800';
                          paymentIcon = 'fa-check-circle';
                        } else if (itemPaymentStatusLower === 'pending') {
                          paymentBadgeClass = 'bg-yellow-100 text-yellow-800';
                          paymentIcon = 'fa-clock';
                        } else if (itemPaymentStatusLower === 'failed') {
                          paymentBadgeClass = 'bg-red-100 text-red-800';
                          paymentIcon = 'fa-times-circle';
                        } else if (itemPaymentStatusLower === 'refunded') {
                          paymentBadgeClass = 'bg-purple-100 text-purple-800';
                          paymentIcon = 'fa-undo';
                        } else if (itemPaymentStatusLower === 'refund approved') {
                          paymentBadgeClass = 'bg-blue-100 text-blue-800';
                          paymentIcon = 'fa-check-circle';
                        } else if (itemPaymentStatusLower === 'return requested') {
                          paymentBadgeClass = 'bg-yellow-100 text-yellow-800';
                          paymentIcon = 'fa-clock';
                        }
                      %>
                      <span
                        class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= paymentBadgeClass %>"
                      >
                        <i class="fas <%= paymentIcon %> text-xs mr-1"></i>
                        <%= itemPaymentStatus %>
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <div class="flex flex-col gap-1 items-center">
                        <% if (canApproveReturn) { %>
                          <button
                            onclick="approveItemReturn('<%= order._id %>', '<%= item._id %>')"
                            class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 transition text-xs font-medium action-btn"
                          >
                            <i class="fas fa-check mr-1"></i> Approve
                          </button>
                        <% } %>
                        
                        <% if (canRejectReturn) { %>
                          <button
                            onclick="rejectItemReturn('<%= order._id %>', '<%= item._id %>')"
                            class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-xs font-medium action-btn"
                          >
                            <i class="fas fa-times mr-1"></i> Reject
                          </button>
                        <% } %>
                        
                        <% if (canRefund) { %>
                          <button
                            onclick="refundItem('<%= order._id %>', '<%= item._id %>', <%= (item.price || 0) * (item.quantity || 1) %>)"
                            class="px-3 py-1 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-xs font-medium action-btn"
                          >
                            <i class="fas fa-money-check-alt mr-1"></i> Refund
                          </button>
                        <% } %>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-center text-sm">
                      <% if (item.returnReason) { %>
                        <span class="text-xs text-gray-700 px-2 py-1 bg-gray-100 rounded">
                          <%= item.returnReason %>
                        </span>
                      <% } else { %>
                        <span class="text-xs text-gray-400">-</span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4 text-center text-sm font-semibold text-gray-800">
                      â‚¹<%= Number((item.price || 0) * (item.quantity || 1)).toFixed(2) %>
                    </td>
                  </tr>
                  <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                        No items found in this order
                      </td>
                    </tr>
                  <% } %>
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td colspan="9" class="px-6 py-4 text-right text-sm font-semibold text-gray-700">
                      Original Amount:
                    </td>
                    <td class="px-6 py-4 text-center text-sm font-bold text-gray-900">
                      â‚¹<%= Number(order.totalPrice || 0).toFixed(2) %>
                    </td>
                  </tr>
                  
                  <% if (order.discount && order.discount > 0) { %>
                    <tr>
                      <td colspan="9" class="px-6 py-4 text-right text-sm font-semibold text-gray-700">
                        Discount Applied:
                      </td>
                      <td class="px-6 py-4 text-center text-sm font-bold text-green-600">
                        -â‚¹<%= Number(order.discount || 0).toFixed(2) %>
                      </td>
                    </tr>
                  <% } %>
                  
                  <tr>
                    <td colspan="9" class="px-6 py-4 text-right text-sm font-semibold text-gray-800">
                      Final Payable Amount:
                    </td>
                    <td class="px-6 py-4 text-center text-sm font-bold text-gray-900">
                      â‚¹<%= Number(order.finalAmount || 0).toFixed(2) %>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const statusFlow = ["Pending", "Processing", "Shipped", "Delivered"];

      function getNextValidStatuses(currentStatus) {
        const blocked = ["Cancelled", "Delivered"];

        if (blocked.includes(currentStatus)) {
          return [];
        }

        const idx = statusFlow.indexOf(currentStatus);
        const nextStatuses = [];

        if (idx !== -1 && idx + 1 < statusFlow.length) {
          nextStatuses.push(statusFlow[idx + 1]);
        }


        return [...new Set(nextStatuses)];
      }

      function getItemNextValidStatuses(currentStatus, orderStatus) {
        const hardFinal = ["Cancelled", "Returned", "Return Approved"];

        if (hardFinal.includes(currentStatus)) {
          return [];
        }

        if (currentStatus === "Delivered" && orderStatus === "Delivered") {
          return ["Return Requested"];
        }

        if (currentStatus === "Return Requested") {
          return ["Return Approved", "Delivered"];
        }

        if (currentStatus === "Return Approved") {
          return ["Returned", "Return Requested"];
        }

        const idx = statusFlow.indexOf(currentStatus);
        const nextStatuses = [];

        if (idx !== -1 && idx + 1 < statusFlow.length) {
          nextStatuses.push(statusFlow[idx + 1]);
        }


        return [...new Set(nextStatuses)];
      }

      function populateOrderStatusSelect() {
        const orderStatusSelect = document.getElementById("orderStatusSelect");
        if (!orderStatusSelect) return;

        const currentStatus = orderStatusSelect.dataset.currentStatus;
        const validStatuses = getNextValidStatuses(currentStatus);

        orderStatusSelect.innerHTML = "";

        const currentOption = document.createElement("option");
        currentOption.value = currentStatus;
        currentOption.textContent = currentStatus + " (Current)";
        currentOption.disabled = true;
        currentOption.selected = true;
        orderStatusSelect.appendChild(currentOption);

        validStatuses.forEach((status) => {
          const option = document.createElement("option");
          option.value = status;

          if (status === "Processing") option.textContent = "Processing ðŸ”„";
          else if (status === "Shipped") option.textContent = "Shipped ðŸšš";
          else if (status === "Delivered") option.textContent = "Delivered âœ…";
          else option.textContent = status;

          orderStatusSelect.appendChild(option);
        });

        if (validStatuses.length === 0) {
          orderStatusSelect.disabled = true;
          orderStatusSelect.title = "No further status updates available";
        }
      }

      function populateItemStatusSelects() {
        const orderStatus = "<%= order.orderStatus %>";

        document.querySelectorAll(".item-status-select").forEach((select) => {
          const currentStatus = select.dataset.currentStatus;
          const validStatuses = getItemNextValidStatuses(
            currentStatus,
            orderStatus
          );

          select.innerHTML = "";

          const currentOption = document.createElement("option");
          currentOption.value = currentStatus;
          currentOption.textContent = currentStatus + " (Current)";
          currentOption.disabled = true;
          currentOption.selected = true;
          select.appendChild(currentOption);

          validStatuses.forEach((status) => {
            const option = document.createElement("option");
            option.value = status;

            if (status === "Processing") option.textContent = "Processing ðŸ”„";
            else if (status === "Shipped") option.textContent = "Shipped ðŸšš";
            else if (status === "Delivered") option.textContent = "Delivered âœ…";
            else if (status === "Return Requested") option.textContent = "Return Requested ðŸ“¦";
            else if (status === "Return Approved") option.textContent = "Return Approved âœ…";
            else if (status === "Returned") option.textContent = "Returned ðŸ”„";
            else option.textContent = status;

            select.appendChild(option);
          });

          if (validStatuses.length === 0) {
            select.disabled = true;
            select.title = "Item is " + currentStatus.toLowerCase() + " - no updates allowed";
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        populateOrderStatusSelect();
        populateItemStatusSelects();

        const orderStatus = "<%= order.orderStatus %>";
        if (orderStatus === "Cancelled" || orderStatus === "Delivered") {
          const select = document.getElementById("orderStatusSelect");
          if (select) {
            select.disabled = true;
            select.title = "Order is " + orderStatus.toLowerCase() + " - no updates allowed";
          }
        }
      });

      const orderStatusSelect = document.getElementById("orderStatusSelect");
      const orderStatusBadge = document.getElementById("orderStatusBadge");

      if (orderStatusSelect) {
        orderStatusSelect.addEventListener("change", async (e) => {
          const orderId = e.target.dataset.orderId;
          const newStatus = e.target.value;
          const currentStatus = e.target.dataset.currentStatus;

          if (newStatus === currentStatus) {
            e.target.value = currentStatus;
            return;
          }

          const result = await Swal.fire({
            title: "Update Order Status?",
            html: "Change order status from <strong>" +
              currentStatus +
              "</strong> to <strong>" +
              newStatus +
              "</strong>?<br><br><span class='text-sm text-gray-600'>This will update all active items in the order.</span>",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#6b7280",
            confirmButtonText: "Yes, update it!",
            cancelButtonText: "Cancel",
          });

          if (!result.isConfirmed) {
            e.target.value = currentStatus;
            return;
          }

          try {
            const res = await axios.put(
              "/admin/adminOrders/" + orderId + "/status",
              {
                status: newStatus,
              }
            );

            if (res.data.success) {
              Swal.fire({
                icon: "success",
                title: "Updated!",
                text: "Order status updated successfully",
                timer: 1500,
                showConfirmButton: false,
              });

              orderStatusBadge.textContent = newStatus;

              orderStatusBadge.className =
                "inline-flex items-center px-3 py-1 rounded-full text-sm font-medium";
              if (newStatus === "Delivered") {
                orderStatusBadge.classList.add("bg-green-100", "text-green-800");
              } else if (newStatus === "Shipped") {
                orderStatusBadge.classList.add("bg-blue-100", "text-blue-800");
              } else if (newStatus === "Processing") {
                orderStatusBadge.classList.add("bg-indigo-100", "text-indigo-800");
              } else {
                orderStatusBadge.classList.add("bg-yellow-100", "text-yellow-800");
              }

              e.target.dataset.currentStatus = newStatus;

              populateOrderStatusSelect();
              populateItemStatusSelects();

              if (newStatus === "Delivered") {
                document.querySelectorAll(".item-status-select").forEach((select) => {
                  select.disabled = true;
                  select.title = "Order is delivered - no updates allowed";
                });

                setTimeout(() => {
                  window.location.reload();
                }, 2000);
              }
            }
          } catch (err) {
            Swal.fire({
              icon: "error",
              title: "Update Failed!",
              text: err.response?.data?.message || "Failed to update order status",
            });

            e.target.value = currentStatus;
          }
        });
      }

      document.addEventListener("change", async (e) => {
        if (e.target.classList.contains("item-status-select")) {
          const itemId = e.target.dataset.itemId;
          const orderId = e.target.dataset.orderId;
          const newStatus = e.target.value;
          const currentStatus = e.target.dataset.currentStatus;

          if (newStatus === currentStatus) {
            e.target.value = currentStatus;
            return;
          }

          const isReturnRequesting = newStatus === "Return Requested";
          const isReturnApproving = newStatus === "Return Approved";
          const isMarkingDelivered = newStatus === "Delivered";
          const isReturned = newStatus === "Returned";

          let title = "Update Item Status?";
          let text = "Change item status from <strong>" + currentStatus + "</strong> to <strong>" + newStatus + "</strong>?";
          let icon = "question";

          if (isReturnRequesting) {
            title = "Mark as Return Requested?";
            text = "Mark this item as 'Return Requested'?<br><br><strong class='text-yellow-600'>Item will be marked for return approval.</strong>";
            icon = "question";
          } else if (isReturnApproving) {
            title = "Approve Item Return?";
            text = "Approve return for this item?<br><br><strong class='text-green-600'>Item will be ready for refund processing.</strong>";
            icon = "question";
          } else if (isReturned) {
            title = "Mark as Returned?";
            text = "Mark this item as 'Returned'?<br><br><strong class='text-purple-600'>Item will be marked as returned and stock will be restored.</strong>";
            icon = "question";
          } else if (isMarkingDelivered) {
            title = "Mark as Delivered?";
            text = "Mark this item as 'Delivered'?<br><br><strong class='text-green-600'>Item will be marked as successfully delivered.</strong>";
            icon = "question";
          }

          const result = await Swal.fire({
            title: title,
            html: text,
            icon: icon,
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#6b7280",
            confirmButtonText: "Yes, update!",
            cancelButtonText: "Cancel",
          });

          if (!result.isConfirmed) {
            e.target.value = currentStatus;
            return;
          }

          try {
            const res = await axios.put(
              "/admin/adminOrders/" + orderId + "/item/" + itemId + "/status",
              {
                status: newStatus,
              }
            );

            if (res.data.success) {
              Swal.fire({
                icon: "success",
                title: "Updated!",
                text: res.data.message || "Item status updated successfully",
                timer: 1500,
                showConfirmButton: false,
              });

              e.target.dataset.currentStatus = newStatus;

              const finalStates = ["Cancelled", "Returned", "Return Approved"];
              if (finalStates.includes(newStatus)) {
                e.target.disabled = true;
                e.target.title = "Item is " + newStatus.toLowerCase() + " - no updates allowed";

                const td = e.target.closest("td");
                if (td) {
                  const badgeClass =
                    newStatus === "Cancelled"
                      ? "bg-red-100 text-red-800"
                      : newStatus === "Returned"
                      ? "bg-purple-100 text-purple-800"
                      : newStatus === "Return Approved"
                      ? "bg-blue-100 text-blue-800"
                      : "bg-yellow-100 text-yellow-800";

                  const badgeHtml =
                    '<span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium item-status-badge ' +
                    badgeClass +
                    '">' +
                    newStatus +
                    "</span>";
                  td.innerHTML = badgeHtml;
                }
              }

              if (isReturnApproving) {
                Swal.fire({
                  icon: "info",
                  title: "Return Approved",
                  text: "Item return has been approved. You can now process refund for this item.",
                  confirmButtonColor: "#3085d6",
                });
              }

              setTimeout(() => {
                window.location.reload();
              }, 2000);
            }
          } catch (err) {
            Swal.fire({
              icon: "error",
              title: "Update Failed!",
              text: err.response?.data?.message || "Failed to update item status",
            });

            e.target.value = currentStatus;
          }
        }
      });

      async function approveItemReturn(orderId, itemId) {
        const result = await Swal.fire({
          title: "Approve Item Return?",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#10b981",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Yes, Approve Return",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          const response = await axios.put(
            `/admin/adminOrders/${orderId}/item/${itemId}/approve-return`
          );

          if (response.data.success) {
            Swal.fire({
              icon: "success",
              title: "Return Approved!",
              text: response.data.message,
              confirmButtonColor: "#10b981",
            }).then(() => {
              window.location.reload();
            });
          }
        } catch (error) {
          console.error("Approve item return error:", error);
          Swal.fire({
            icon: "error",
            title: "Approval Failed",
            text: error.response?.data?.message || "Failed to approve item return",
            confirmButtonColor: "#d33",
          });
        }
      }

      async function rejectItemReturn(orderId, itemId) {
        const result = await Swal.fire({
          title: "Reject Item Return?",
          html: "Are you sure you want to reject return for this item?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Yes, Reject Return",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          const response = await axios.put(
            `/admin/adminOrders/${orderId}/item/${itemId}/reject-return`
          );

          if (response.data.success) {
            Swal.fire({
              icon: "success",
              title: "Return Rejected!",
              text: response.data.message,
              confirmButtonColor: "#10b981",
            }).then(() => {
              window.location.reload();
            });
          }
        } catch (error) {
          console.error("Reject item return error:", error);
          Swal.fire({
            icon: "error",
            title: "Rejection Failed",
            text: error.response?.data?.message || "Failed to reject item return",
            confirmButtonColor: "#d33",
          });
        }
      }

      async function refundItem(orderId, itemId, refundAmount) {
        const result = await Swal.fire({
          title: "Process Refund for this Item?",
          html: `Are you sure you want to process refund for this item? <br><br>Refund Amount:</strong> â‚¹${refundAmount.toFixed(2)}`,
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#10b981",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Yes, Process Refund",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          const response = await axios.put(
            `/admin/adminOrders/${orderId}/item/${itemId}/refund`,
            {
              refundAmount: refundAmount,
            }
          );

          if (response.data.success) {
            Swal.fire({
              icon: "success",
              title: "Refund Processed!",
              text: response.data.message,
              confirmButtonColor: "#10b981",
            }).then(() => {
              window.location.reload();
            });
          }
        } catch (error) {
          console.error("Refund item error:", error);
          Swal.fire({
            icon: "error",
            title: "Refund Failed",
            text: error.response?.data?.message || "Failed to process item refund",
            confirmButtonColor: "#d33",
          });
        }
      }
    </script>
  </body>
</html>