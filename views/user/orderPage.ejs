<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rube Collection - My Orders</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: "Lato", sans-serif; }
    .order-image { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; }
  </style>
</head>

<body class="bg-gray-50">
  <%- include("../partials/user/header.ejs") %>

  <div class="max-w-full mx-auto px-6 lg:px-12 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <%- include("../partials/user/profileSidebar.ejs") %>

      <div class="flex-1">
        <div class="bg-gray-100 rounded-lg p-6 lg:p-8">
          <div class="bg-white rounded-lg shadow-sm p-6 lg:p-10">

            <div class="flex items-center justify-between mb-8">
              <h2 class="text-xl font-medium text-gray-800">My Orders</h2>
              <a href="/product" class="px-6 py-2 rounded-full bg-red-700 text-white text-sm hover:bg-red-800 whitespace-nowrap">
                <i class="fas fa-shopping-bag mr-2"></i>Continue Shopping
              </a>
            </div>

            <% if (orders && orders.length > 0) { %>

            <!-- SEARCH BAR -->
            <div class="mb-6">
              <input 
                type="text" 
                id="orderSearchInput"
                placeholder="Search by Order ID..."
                class="w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-md focus:ring-red-700 focus:border-red-700"
              />
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="text-center">
                  <p class="text-xs text-blue-600 font-medium uppercase">Total Orders</p>
                  <p class="text-2xl font-bold text-blue-700"><%= totalOrders %></p>
                </div>
              </div>

              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="text-center">
                  <p class="text-xs text-green-600 font-medium uppercase">Total Items</p>
                  <p class="text-2xl font-bold text-green-700">
                    <%= totalItems %>
                  </p>
                </div>
              </div>

              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="text-center">
                  <p class="text-xs text-purple-600 font-medium uppercase">Total Spent</p>
                  <p class="text-2xl font-bold text-purple-700">
                    ₹<%= totalRevenue %>
                  </p>
                </div>
              </div>
            </div>

            <div class="hidden md:block overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Order ID</th>
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Items</th>
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Total</th>
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Status</th>
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Order Date</th>
                    <th class="text-left py-3 px-3 font-semibold text-gray-700 uppercase text-xs">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  <% orders.forEach(order => { 
                     const status = order.orderStatus || "Pending";
                  %>
                    <tr class="order-row border-b border-gray-100 hover:bg-gray-50">
                      <td class="py-4 px-3">
                        <span class="order-id text-gray-800 font-medium"> #<%= order.orderId || order._id.toString().slice(-8) %>
                      </span>
                      </td>

                      <td class="py-4 px-3">
                        <span class="text-gray-600"><%= order.orderedItem?.length || 0 %> items</span>
                      </td>

                      <td class="py-4 px-3">
                        <span class="text-gray-800 font-semibold">₹<%= parseFloat(order.finalAmount || order.totalPrice || 0).toFixed(2) %></span>
                      </td>

                      <td class="py-4 px-3">
                        <% 
                          let statusClass = 'bg-gray-100 text-gray-700';
                          if (status === 'Delivered') statusClass = 'bg-green-100 text-green-700';
                          else if (status === 'Shipped') statusClass = 'bg-blue-100 text-blue-700';
                          else if (status === 'Processing') statusClass = 'bg-yellow-100 text-yellow-700';
                          else if (status === 'Cancelled') statusClass = 'bg-red-100 text-red-700';
                          else if (status === 'Pending') statusClass = 'bg-orange-100 text-orange-700';
                        %>

                        <span class="text-xs px-3 py-1 <%= statusClass %> rounded-full font-medium capitalize">
                          <%= status %>
                        </span>
                      </td>

                      <td class="py-4 px-3 text-gray-600 text-xs">
                        <%= new Date(order.createdAt).toLocaleDateString() %>
                      </td>

                      <td class="py-4 px-3">
                        <div class="flex items-center gap-2">
                          <a href="/orders/<%= order._id %>" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition text-xs font-medium">
                            <i class="fas fa-eye mr-1"></i>View
                          </a>

                          <% const canCancel = ['Pending', 'Processing'].includes(status); %>
                          <% if (canCancel) { %>
                            <button onclick="cancelEntireOrder('<%= order._id %>')" class="bg-red-700 text-white px-4 py-2 rounded-md hover:bg-red-800 transition text-xs font-medium">
                              <i class="fas fa-times mr-1"></i>Cancel
                            </button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <div class="md:hidden space-y-4">
              <% orders.forEach(order => { 
                 const status = order.orderStatus || "Pending";
                 const orderShortId = order._id.toString().slice(-8).toUpperCase();
              %>
                <div class="order-card border border-gray-200 rounded-lg p-4 bg-gray-50 hover:bg-white hover:shadow-md transition"
                     data-order-id="<%= orderShortId %>">

                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <p class="text-xs text-gray-500 mb-1">Order ID</p>
                      <p class="text-sm font-semibold text-gray-800">#<%= orderShortId %></p>
                    </div>

                    <% 
                      let statusClass = 'bg-gray-100 text-gray-700';
                      if (status === 'Delivered') statusClass = 'bg-green-100 text-green-700';
                      else if (status === 'Shipped') statusClass = 'bg-blue-100 text-blue-700';
                      else if (status === 'Processing') statusClass = 'bg-yellow-100 text-yellow-700';
                      else if (status === 'Cancelled') statusClass = 'bg-red-100 text-red-700';
                      else if (status === 'Pending') statusClass = 'bg-orange-100 text-orange-700';
                    %>

                    <span class="text-xs px-3 py-1 <%= statusClass %> rounded-full font-medium capitalize">
                      <%= status %>
                    </span>
                  </div>

                  <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                    <div>
                      <p class="text-gray-500 text-xs">Items</p>
                      <p class="font-medium text-gray-800"><%= order.orderedItem?.length || 0 %> items</p>
                    </div>

                    <div>
                      <p class="text-gray-500 text-xs">Total</p>
                      <p class="font-semibold text-gray-800">₹<%= parseFloat(order.finalAmount || order.totalPrice || 0).toFixed(2) %></p>
                    </div>

                    <div class="col-span-2">
                      <p class="text-gray-500 text-xs">Order Date</p>
                      <p class="font-medium text-gray-800"><%= new Date(order.createdAt).toLocaleDateString() %></p>
                    </div>
                  </div>

                  <div class="flex gap-2 pt-3 border-t border-gray-200">
                    <a href="/orders/<%= order._id %>" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition text-xs font-medium text-center">
                      <i class="fas fa-eye mr-1"></i>View Details
                    </a>

                    <% const canCancel = ['Pending', 'Processing'].includes(status); %>
                    <% if (canCancel) { %>
                      <button onclick="cancelEntireOrder('<%= order._id %>')" class="flex-1 bg-red-700 text-white px-4 py-2 rounded-md hover:bg-red-800 transition text-xs font-medium">
                        <i class="fas fa-times mr-1"></i>Cancel
                      </button>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>

            <% } else { %>
              <div class="text-center py-16 text-gray-500">
                <i class="fas fa-shopping-bag text-5xl mb-4 text-gray-400"></i>
                <p class="text-lg mb-6">No orders found. Start shopping now!</p>
                <a href="/product" class="inline-block bg-red-700 text-white px-6 py-3 rounded-md hover:bg-red-800 transition font-medium">
                  <i class="fas fa-shopping-bag mr-2"></i>Start Shopping
                </a>
              </div>
            <% } %>

            <% if (totalPages > 1) { %>
              <div class="flex justify-center mt-8 space-x-2">
                <% if (page > 1) { %>
                  <a href="/orders?page=<%= page - 1 %>" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded">
                    <i class="fas fa-chevron-left mr-1"></i>Previous
                  </a>
                <% } %>

                <% for (let i = 1; i <= totalPages; i++) { %>
                  <a href="/orders?page=<%= i %>" class="px-4 py-2 rounded <%= i === page ? 'bg-red-700 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-700' %>">
                    <%= i %>
                  </a>
                <% } %>

                <% if (page < totalPages) { %>
                  <a href="/orders?page=<%= page + 1 %>" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded">
                    Next<i class="fas fa-chevron-right ml-1"></i>
                  </a>
                <% } %>
              </div>
            <% } %>

          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include("../partials/user/footer.ejs") %>

  <script>
    function cancelEntireOrder(orderId) {
      Swal.fire({
        title: "Cancel Order?",
        html: `
          <div class="text-left">
            <p class="text-sm text-gray-600 mb-3">This will cancel all items in this order.</p>
            <label class="block text-sm font-medium text-gray-700 mb-2">Reason (Optional)</label>
            <textarea id="cancelOrderReason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-600 focus:border-red-600" placeholder="Write your reason..." rows="3"></textarea>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: "Yes, Cancel Order",
        cancelButtonText: "No, Keep It",
        confirmButtonColor: "#b91c1c",
        cancelButtonColor: "#6b7280",
        showLoaderOnConfirm: true,
        preConfirm: () => {
          return {
            reason: document.getElementById("cancelOrderReason").value || "",
            cancelAll: true
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          axios.post(`/orders/cancel/${orderId}`, result.value)
          .then(res => {
            if (res.data.success) {
              Swal.fire({
                icon: "success",
                title: "Order Cancelled",
                timer: 2000,
                showConfirmButton: false
              }).then(() => window.location.reload());
            }
          });
        }
      });
    }

    document.getElementById("orderSearchInput")?.addEventListener("input", function () {
      const filter = this.value.toLowerCase();

      document.querySelectorAll(".order-row").forEach(row => {
        const idText = row.querySelector(".order-id").innerText.toLowerCase();
        row.style.display = idText.includes(filter) ? "" : "none";
      });

      document.querySelectorAll(".order-card").forEach(card => {
        const id = card.getAttribute("data-order-id").toLowerCase();
        card.style.display = id.includes(filter) ? "" : "none";
      });
    });
  </script>

</body>
</html>
