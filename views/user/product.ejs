<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Read Valentine - Perfume Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .main-content {
      flex: 1 0 auto;
    }
    .footer {
      flex-shrink: 0;
    }
    .filter-content {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }
    .filter-content.collapsed {
      max-height: 0;
      opacity: 0;
    }
    .filter-content.expanded {
      max-height: 500px;
      opacity: 1;
    }
    .product-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .product-card:hover {
      transform: translateY(-4px);
    }
    .size-btn.active {
      background-color: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    img {
      max-width: 100%;
      height: auto;
    }
    
    .header-gap {
      margin-top: 2rem;
    }
    
    #clear-search, #search-btn {
      transition: all 0.2s ease-in-out;
    }
    
    #clear-search:hover, #search-btn:hover {
      transform: scale(1.1);
    }
    
    #search-input:focus + div #search-btn,
    #search-input:focus + div #clear-search {
      color: #dc2626;
    }

    .wishlist-btn {
      transition: all 0.3s ease;
    }
    
    .wishlist-btn:hover {
      transform: scale(1.1);
    }

    .wishlist-btn.active i {
      color: #dc2626 !important;
    }

    .wishlist-btn.active {
      background-color: #fef2f2;
    }
    
    @media (max-width: 768px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .header-gap {
        margin-top: 1rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
  <%- include('../partials/user/header') %> 

  <main class="main-content flex-1 w-full header-gap">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center mb-12"></div>

      <div class="flex flex-col lg:flex-row gap-8">
        <aside class="lg:w-1/4" aria-label="Product filters">
          <section class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="font-semibold mb-4 text-gray-700 text-lg">SEARCH</h3>
            <div class="relative">
              <input 
                type="text" 
                id="search-input"
                placeholder="Search products..." 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-20 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                aria-label="Search products"
              >
              <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                <button 
                  id="clear-search" 
                  class="text-gray-400 hover:text-red-600 transition-colors duration-200 opacity-0 pointer-events-none"
                  aria-label="Clear search"
                  style="transition: opacity 0.2s ease;"
                >
                  <i class="fas fa-times-circle text-lg"></i>
                </button>
                
                <button 
                  id="search-btn"
                  class="text-gray-400 hover:text-red-600 transition-colors duration-200"
                  aria-label="Search"
                >
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </section>

          <section class="bg-white p-6 rounded-lg shadow mb-6">
            <button class="filter-toggle flex justify-between items-center w-full mb-4" aria-expanded="true">
              <h3 class="font-semibold text-gray-700 text-lg">BRANDS</h3>
              <span class="text-gray-400 transform transition-transform">
                <i class="fas fa-chevron-down"></i>
              </span>
            </button>

            <div class="filter-content expanded space-y-3">
              <% if (brands && brands.length > 0) { %>
                <% brands.forEach(brand => { %>
                  <div class="form-check">
                    <input 
                      type="checkbox" 
                      class="brand-filter mr-3 rounded border-gray-300 text-red-600 focus:ring-red-500" 
                      value="<%= brand._id %>" 
                      id="brand-<%= brand._id %>"
                    >
                    <label for="brand-<%= brand._id %>" class="text-gray-600 text-sm cursor-pointer hover:text-gray-800">
                      <%= brand.name %>
                    </label>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-gray-500 text-sm">No brands available</p>
              <% } %>
            </div>
          </section>

          <section class="bg-white p-6 rounded-lg shadow mb-6">
            <button class="filter-toggle flex justify-between items-center w-full mb-4" aria-expanded="true">
              <h3 class="font-semibold text-gray-700 text-lg">CATEGORIES</h3>
              <span class="text-gray-400 transform transition-transform">
                <i class="fas fa-chevron-down"></i>
              </span>
            </button>

            <div class="filter-content expanded space-y-3">
              <% if (categories && categories.length > 0) { %>
                <% categories.forEach(category => { %>
                  <div class="form-check">
                    <input 
                      type="checkbox" 
                      class="category-filter mr-3 rounded border-gray-300 text-red-600 focus:ring-red-500" 
                      value="<%= category._id %>" 
                      id="category-<%= category._id %>"
                    >
                    <label 
                      for="category-<%= category._id %>" 
                      class="text-gray-600 text-sm cursor-pointer hover:text-gray-800">
                      <%= category.name %>
                    </label>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-gray-500 text-sm">No categories available</p>
              <% } %>
            </div>
          </section>

          <section class="bg-white p-6 rounded-lg shadow mb-6">
            <button class="filter-toggle flex justify-between items-center w-full mb-4" aria-expanded="true">
              <h3 class="font-semibold text-gray-700 text-lg">PRICE RANGE</h3>
              <span class="text-gray-400 transform transition-transform">
                <i class="fas fa-chevron-down"></i>
              </span>
            </button>
            <div class="filter-content expanded">
              <div class="flex justify-between mb-2">
                <span class="text-sm text-gray-600">Min: ₹<span id="min-price">0</span></span>
                <span class="text-sm text-gray-600">Max: ₹<span id="max-price">5000</span></span>
              </div>
              <input 
                type="range" 
                id="price-range"
                min="0" 
                max="10000" 
                value="5000"
                step="100"
                class="w-full mb-4 accent-red-600 cursor-pointer"
                aria-label="Price range filter"
              >
            </div>
          </section>

          <section class="bg-white p-6 rounded-lg shadow mb-6">
            <button class="filter-toggle flex justify-between items-center w-full mb-4" aria-expanded="true">
              <h3 class="font-semibold text-gray-700 text-lg">SIZE (ML)</h3>
              <span class="text-gray-400 transform transition-transform">
                <i class="fas fa-chevron-down"></i>
              </span>
            </button>
            <div class="filter-content expanded">
              <div class="flex flex-wrap gap-3">
                <button class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200" data-size="30">30ML</button>
                <button class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200" data-size="50">50ML</button>
                <button class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200" data-size="75">75ML</button>
                <button class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200" data-size="100">100ML</button>
                <button class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200" data-size="200">200ML</button>
              </div>
            </div>
          </section>

          <button id="clear-filters" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-4 rounded-lg transition-colors duration-200 mb-6">
            Clear All Filters
          </button>
        </aside>

        <div class="lg:w-3/4">
          <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 bg-white p-6 rounded-lg shadow">
  <p class="text-gray-600 text-base">
    Showing <span id="showing-count" class="font-semibold text-gray-800">
      <% 
        const productsCount = products.length;
        const showingStart = productsCount > 0 ? 1 : 0;
        const showingEnd = productsCount;
      %>
      <%= showingStart %>-<%= showingEnd %>
    </span> of <span id="total-count" class="font-semibold text-gray-800"><%= totalProducts %></span> results
  </p>
  <div class="flex items-center gap-3">
    <span class="text-gray-600 text-base hidden sm:block">Sort by:</span>
    <select id="sort-select" class="border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent text-base">
      <option value="latest" selected>Latest</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
      <option value="name">Name: A to Z</option>
    </select>
  </div>
</header>

          <section aria-label="Product listings" class="w-full">
            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              <!-- Initial server-rendered products -->
              <% if (products && products.length > 0) { %>
                <% products.forEach(product => { %>
                  <% 
                    const productId = product._id;
                    const productName = product.productName || 'Unnamed Product';
                    const productPrice = typeof product.price === 'number' ? product.price : 0;
                    const productOldPrice = product.oldPrice || null;
                    const hasDiscount = productOldPrice && productOldPrice > productPrice;
                    const productImages = Array.isArray(product.images) ? product.images : [];
                    const mainImage = productImages.length > 0 ? productImages[0] : 'https://via.placeholder.com/300x400/f3f4f6/000?text=Perfume+Image';
                    const hasStock = product.hasStock || false;
                    const inStock = hasStock && product.isListed !== false;
                    const brandName = product.brand?.name || '';
                    const categoryName = product.category?.name || '';
                    const isInWishlist = userWishlist.includes(productId.toString());
                    const heartIconClass = isInWishlist ? 'fas fa-heart' : 'far fa-heart';
                    const activeClass = isInWishlist ? 'active' : '';
                  %>
                  
                  <article class="bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 product-card group h-full flex flex-col" data-product-id="<%= productId %>">
                    <div class="relative h-80 rounded-t-lg overflow-hidden flex-shrink-0">
                      <!-- Wishlist Heart Icon -->
                      <button 
                        class="wishlist-btn absolute top-3 right-3 z-20 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center hover:bg-red-50 transition-all duration-300 <%= activeClass %>"
                        data-product-id="<%= productId %>"
                        aria-label="<%= isInWishlist ? 'Remove from wishlist' : 'Add to wishlist' %>"
                      >
                        <i class="<%= heartIconClass %> text-red-600 text-lg"></i>
                      </button>

                      <a href="/product/<%= productId %>" class="block h-full">
                        <img 
                          src="<%= mainImage %>" 
                          alt="<%= productName %>"
                          class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                          onerror="this.src='https://via.placeholder.com/300x400/f3f4f6/000?text=Perfume+Image'"
                        >

                        <% if (!inStock) { %>
                          <div class="absolute top-4 left-4 bg-gray-800 text-white px-3 py-1 rounded-full text-xs font-medium">
                            Out of Stock
                          </div>
                        <% } %>

                        <% if (product.bestDiscount && product.bestDiscount > 0) { %>
                          <div class="absolute top-4 left-4 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                            <%= product.bestDiscount %>% OFF
                          </div>
                        <% } %>
                      </a>
                    </div>

                    <div class="p-6 text-center flex-grow flex flex-col justify-end">
                      <a href="/product/<%= productId %>" class="block">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 line-clamp-2 hover:text-red-600 transition-colors" title="<%= productName %>">
                          <%= productName %>
                        </h3>
                      </a>
                      
                      <div class="flex items-center justify-center gap-2 mb-2">
                        <p class="text-red-600 font-bold text-xl">₹<%= productPrice.toFixed(2) %></p>
                        <% if (hasDiscount) { %>
                          <p class="text-gray-500 line-through text-sm">₹<%= productOldPrice.toFixed(2) %></p>
                        <% } %>
                      </div>
                      
                      <% if (brandName) { %>
                        <p class="text-gray-500 text-sm mb-1"><%= brandName %></p>
                      <% } %>
                      
                      <% if (inStock) { %>
                        <p class="text-green-600 text-sm mt-2 flex items-center justify-center">
                          <i class="fas fa-check-circle mr-1"></i> In Stock
                        </p>
                      <% } else { %>
                        <p class="text-red-500 text-sm mt-2 flex items-center justify-center">
                          <i class="fas fa-times-circle mr-1"></i> Out of Stock
                        </p>
                      <% } %>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <div class="col-span-full text-center py-12">
                  <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                  <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
                  <p class="text-gray-500">Try adjusting your filters or search terms</p>
                </div>
              <% } %>
            </div>
          </section>

          <nav id="pagination-container" class="flex justify-center items-center mt-12 space-x-3" aria-label="Product pagination">
  <% if (totalProducts > 0) { %>
    <% 
      const hasNextPage = totalPages > 1;
      const hasPrevPage = false; // First page
    %>
    <button id="prev-page" class="px-5 py-3 border border-gray-300 rounded-lg hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200 font-medium <%= hasPrevPage ? '' : 'opacity-50 cursor-not-allowed' %>" <%= hasPrevPage ? '' : 'disabled' %>>
      ← Previous
    </button>
    
    <% for (let i = 1; i <= Math.min(5, totalPages); i++) { %>
      <button class="page-btn px-5 py-3 border rounded-lg font-medium <%= i === currentPage ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:bg-red-600 hover:text-white hover:border-red-600' %>" data-page="<%= i %>">
        <%= i %>
      </button>
    <% } %>
    
    <button id="next-page" class="px-5 py-3 border border-gray-300 rounded-lg hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200 font-medium <%= hasNextPage ? '' : 'opacity-50 cursor-not-allowed' %>" <%= hasNextPage ? '' : 'disabled' %>>
      Next →
    </button>
  <% } %>
</nav>
        </div>
      </div>
    </div>
  </main>

  <div class="footer w-full mt-12">
    <%- include('../partials/user/footer') %>
  </div>

  <script>
    const serverWishlist = <%- JSON.stringify(userWishlist || []) %>;
    let userWishlist = JSON.parse(localStorage.getItem('userWishlist') || '[]');
    
    const mergedWishlist = [...new Set([...serverWishlist, ...userWishlist])];
    userWishlist = mergedWishlist;
    localStorage.setItem('userWishlist', JSON.stringify(mergedWishlist));

    const showAlert = {
        success: (message, timer = 2000) => {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: message,
                timer: timer,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        },
        error: (message) => {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: message,
                confirmButtonColor: '#dc2626'
            });
        },
        warning: (message) => {
            Swal.fire({
                icon: 'warning',
                title: 'Warning!',
                text: message,
                confirmButtonColor: '#f59e0b'
            });
        },
        info: (message) => {
            Swal.fire({
                icon: 'info',
                title: 'Information',
                text: message,
                confirmButtonColor: '#3b82f6'
            });
        },
        loading: (message = 'Processing...') => {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        },
        close: () => {
            Swal.close();
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
  let currentPage = 1;
  const limit = 12;
  let totalProducts = <%= totalProducts || 0 %>;
  let currentFilters = {};
  
  // Attach event listeners to initial products
  attachProductEventListeners();
  
  // Initialize pagination if there are more products
  if (totalProducts > limit) {
    updatePagination({
      totalPages: <%= totalPages || 1 %>,
      currentPage: 1,
      totalProducts: totalProducts
    });
  }

      const filterToggles = document.querySelectorAll('.filter-toggle');
      
      filterToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          const content = this.parentElement.querySelector('.filter-content');
          const icon = this.querySelector('i');
          
          if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            this.setAttribute('aria-expanded', 'false');
            icon.classList.add('rotate-180');
          } else {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            this.setAttribute('aria-expanded', 'true');
            icon.classList.remove('rotate-180');
          }
        });
      });

      const sizeButtons = document.querySelectorAll('.size-btn');
      sizeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const size = this.dataset.size;
          
          if (this.classList.contains('active')) {
            this.classList.remove('active');
          } else {
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
          }
          filterProducts();
        });
      });

      const priceRange = document.getElementById('price-range');
      if (priceRange) {
        priceRange.addEventListener('input', function() {
          document.getElementById('max-price').textContent = this.value;
        });
        
        let priceTimeout;
        priceRange.addEventListener('change', function() {
          clearTimeout(priceTimeout);
          priceTimeout = setTimeout(filterProducts, 500);
        });
      }

      let filterTimeout;
      document.querySelectorAll('.brand-filter, .category-filter').forEach(filter => {
        filter.addEventListener('change', function() {
          clearTimeout(filterTimeout);
          filterTimeout = setTimeout(filterProducts, 300);
        });
      });

      const searchInput = document.getElementById('search-input');
      const clearSearchBtn = document.getElementById('clear-search');
      const searchBtn = document.getElementById('search-btn');

      if (searchInput && clearSearchBtn && searchBtn) {
        let searchTimeout;
        
        function toggleClearButton() {
          const hasValue = searchInput.value.trim().length > 0;
          if (hasValue) {
            clearSearchBtn.classList.remove('opacity-0', 'pointer-events-none');
            clearSearchBtn.classList.add('opacity-100', 'pointer-events-auto');
          } else {
            clearSearchBtn.classList.remove('opacity-100', 'pointer-events-auto');
            clearSearchBtn.classList.add('opacity-0', 'pointer-events-none');
          }
        }
        
        toggleClearButton();
        
        searchInput.addEventListener('input', function() {
          toggleClearButton();
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(filterProducts, 500);
        });
        
        clearSearchBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          searchInput.value = '';
          searchInput.focus();
          toggleClearButton();
          filterProducts(); 
          
          this.classList.add('scale-110');
          setTimeout(() => {
            this.classList.remove('scale-110');
          }, 150);
        });
        
        searchBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const searchTerm = searchInput.value.trim();
          if (searchTerm.length > 0) {
            filterProducts();
            
            this.classList.add('scale-110');
            setTimeout(() => {
              this.classList.remove('scale-110');
            }, 150);
          }
        });
        
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm.length > 0) {
              filterProducts();
            }
          }
        });
        
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            e.preventDefault();
            this.value = '';
            toggleClearButton();
            filterProducts();
          }
        });
      }

      const sortSelect = document.getElementById('sort-select');
      if (sortSelect) {
        sortSelect.addEventListener('change', function() {
          filterProducts();
        });
      }

      const clearFiltersBtn = document.getElementById('clear-filters');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function(e) {
          e.preventDefault();
          clearAllFilters();
        });
      }

      async function filterProducts() {
  const searchTerm = document.getElementById('search-input').value.trim();
  const selectedBrands = Array.from(document.querySelectorAll('.brand-filter:checked'))
    .map(cb => cb.value);
  
  const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
    .map(cb => cb.value);
  
  const selectedSize = document.querySelector('.size-btn.active')?.dataset.size;
  const maxPrice = document.getElementById('price-range').value;
  const sortBy = document.getElementById('sort-select').value;

  const filters = {};
  
  if (searchTerm) {
    filters.search = searchTerm;
  }
  
  if (selectedBrands.length > 0) {
    filters.brands = selectedBrands.join(',');
  }
  
  if (selectedCategories.length > 0) {
    filters.categories = selectedCategories.join(',');
  }
  
  if (selectedSize) {
    filters.size = selectedSize;
  }
  
  if (maxPrice) {
    filters.maxPrice = maxPrice;
  }
  
  filters.sortBy = sortBy;

  currentFilters = filters;
  currentPage = 1; // Reset to page 1 when filtering
  await loadProductsFromBackend(filters);
}

      async function loadProductsFromBackend(filters = {}) {
        try {
          showLoadingState();
          
          const queryParams = new URLSearchParams({
            page: currentPage,
            limit: limit,
            ...filters
          }).toString();

          const response = await fetch(`/products/filter?${queryParams}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.message || 'Failed to load products');
          }
          
          renderProducts(data.products || []);
          updatePagination(data);
          updateShowingCount(data.products?.length || 0, data.totalProducts || 0);
          
        } catch (error) {
          console.error('Error loading products:', error);
          showErrorState(error.message);
        }
      }

      function renderProducts(productsToRender) {
        const productGrid = document.getElementById('product-grid');
        
        if (!productsToRender || productsToRender.length === 0) {
            productGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
                    <p class="text-gray-500">Try adjusting your filters or search terms</p>
                    <button onclick="clearAllFilters()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        Clear All Filters
                    </button>
                </div>
            `;
            return;
        }

        productGrid.innerHTML = '';

        productsToRender.forEach(product => {
            if (!product || !product._id) {
                console.warn('Invalid product data:', product);
                return;
            }

            const productId = product._id;
            const productName = product.productName || 'Unnamed Product';
            const productPrice = typeof product.price === 'number' ? product.price : 0;
            const productOldPrice = product.oldPrice || null;
            const hasDiscount = productOldPrice && productOldPrice > productPrice;
            const productImages = Array.isArray(product.images) ? product.images : [];
            const mainImage = productImages.length > 0 ? productImages[0] : 'https://via.placeholder.com/300x400/f3f4f6/000?text=Perfume+Image';
            const hasStock = product.hasStock || false;
            const inStock = hasStock && product.isListed !== false;
            const brandName = product.brand?.name || '';
            const isInWishlist = userWishlist.includes(productId);
            const heartIconClass = isInWishlist ? 'fas fa-heart' : 'far fa-heart';
            const activeClass = isInWishlist ? 'active' : '';

            const productElement = document.createElement('article');
            productElement.className = 'bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 product-card group h-full flex flex-col';
            productElement.innerHTML = `
                <div class="relative h-80 rounded-t-lg overflow-hidden flex-shrink-0">
                    <button 
                        class="wishlist-btn absolute top-3 right-3 z-20 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center hover:bg-red-50 transition-all duration-300 ${activeClass}"
                        data-product-id="${productId}"
                        aria-label="${isInWishlist ? 'Remove from wishlist' : 'Add to wishlist'}"
                    >
                        <i class="${heartIconClass} text-red-600 text-lg"></i>
                    </button>

                    <a href="/product/${productId}" class="block h-full">
                        <img 
                            src="${mainImage}" 
                            alt="${productName}"
                            class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                            onerror="this.src='https://via.placeholder.com/300x400/f3f4f6/000?text=Perfume+Image'"
                        >

                        ${!inStock ? `
                            <div class="absolute top-4 left-4 bg-gray-800 text-white px-3 py-1 rounded-full text-xs font-medium">
                                Out of Stock
                            </div>
                        ` : ''}

                        ${product.bestDiscount && product.bestDiscount > 0 ? `
                            <div class="absolute top-4 left-4 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                            ${product.bestDiscount}% OFF
                            </div>
                        ` : ''}
                    </a>
                </div>

                <div class="p-6 text-center flex-grow flex flex-col justify-end">
                    <a href="/product/${productId}" class="block">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 line-clamp-2 hover:text-red-600 transition-colors" title="${productName}">
                            ${productName}
                        </h3>
                    </a>
                    
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <p class="text-red-600 font-bold text-xl">₹${productPrice.toFixed(2)}</p>
                        ${hasDiscount ? `
                            <p class="text-gray-500 line-through text-sm">₹${productOldPrice.toFixed(2)}</p>
                        ` : ''}
                    </div>
                    
                    ${brandName ? `
                        <p class="text-gray-500 text-sm mb-1">${brandName}</p>
                    ` : ''}
                    
                    ${inStock ? `
                        <p class="text-green-600 text-sm mt-2 flex items-center justify-center">
                            <i class="fas fa-check-circle mr-1"></i> In Stock
                        </p>
                    ` : `
                        <p class="text-red-500 text-sm mt-2 flex items-center justify-center">
                            <i class="fas fa-times-circle mr-1"></i> Out of Stock
                        </p>
                    `}
                </div>
            `;
            productGrid.appendChild(productElement);
        });

        attachProductEventListeners();
      }

      function updatePagination(data) {
        const paginationContainer = document.getElementById('pagination-container');
        const totalPages = data.totalPages || 1;
        
        if (!paginationContainer || totalPages <= 1) {
          paginationContainer.style.display = 'none';
          return;
        }
        
        paginationContainer.style.display = 'flex';
        
        let paginationHTML = `
          <button id="prev-page" class="px-5 py-3 border border-gray-300 rounded-lg hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200 font-medium ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
            ← Previous
          </button>
        `;
        
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === currentPage;
          paginationHTML += `
            <button class="page-btn px-5 py-3 border rounded-lg font-medium ${isActive ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:bg-red-600 hover:text-white hover:border-red-600'}" data-page="${i}">
              ${i}
            </button>
          `;
        }
        
        paginationHTML += `
          <button id="next-page" class="px-5 py-3 border border-gray-300 rounded-lg hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors duration-200 font-medium ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
            Next →
          </button>
        `;
        
        paginationContainer.innerHTML = paginationHTML;
        
        document.querySelectorAll('.page-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const page = parseInt(this.dataset.page);
            if (page >= 1 && page <= totalPages) {
              currentPage = page;
              loadProductsFromBackend(currentFilters);
            }
          });
        });
        
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        
        if (prevBtn) {
          prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
              currentPage--;
              loadProductsFromBackend(currentFilters);
            }
          });
        }
        
        if (nextBtn) {
          nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
              currentPage++;
              loadProductsFromBackend(currentFilters);
            }
          });
        }
      }

      function updateShowingCount(showing, total) {
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        
        if (showingCount && totalCount) {
          const start = (currentPage - 1) * limit + 1;
          const end = Math.min(start + showing - 1, total);
          showingCount.textContent = `${start}-${end}`;
          totalCount.textContent = total;
        }
      }

      function attachProductEventListeners() {
        document.querySelectorAll('.wishlist-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                const productId = this.dataset.productId;
                
                if (!productId) {
                    showAlert.error('Invalid product');
                    return;
                }
                
                try {
                    const heartIcon = this.querySelector('i');
                    const isCurrentlyInWishlist = userWishlist.includes(productId);
                    
                    if (isCurrentlyInWishlist) {
                        userWishlist = userWishlist.filter(id => id !== productId);
                        this.classList.remove('active');
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                        
                        const response = await axios.delete(`/wishlist/remove/${productId}`);
                        
                        if (response.data.success) {
                            showAlert.success('Removed from wishlist!');
                            localStorage.setItem('userWishlist', JSON.stringify(userWishlist));
                        } else {
                            userWishlist.push(productId);
                            this.classList.add('active');
                            heartIcon.classList.remove('far');
                            heartIcon.classList.add('fas');
                            showAlert.error(response.data.message || 'Failed to remove from wishlist');
                        }
                    } else {
                        userWishlist.push(productId);
                        this.classList.add('active');
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                        
                        const response = await axios.post('/wishlist/add', {
                            productId: productId
                        });
                        
                        if (response.data.success) {
                            showAlert.success('Added to wishlist!');
                            localStorage.setItem('userWishlist', JSON.stringify(userWishlist));
                        } else {
                            userWishlist = userWishlist.filter(id => id !== productId);
                            this.classList.remove('active');
                            heartIcon.classList.remove('fas');
                            heartIcon.classList.add('far');
                            showAlert.error(response.data.message || 'Failed to add to wishlist');
                        }
                    }
                } catch (error) {
                    console.error('Error with wishlist:', error);
                    
                    if (error.response?.status === 401) {
                        showAlert.warning('Please login to manage your wishlist');
                    } else {
                        showAlert.error('Error updating wishlist');
                    }
                }
            });
        });
      }

      async function clearAllFilters() {
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
  
  document.getElementById('price-range').value = 5000;
  document.getElementById('max-price').textContent = '5000';
  
  document.getElementById('search-input').value = '';
  const clearSearchBtn = document.getElementById('clear-search');
  if (clearSearchBtn) {
    clearSearchBtn.classList.remove('opacity-100', 'pointer-events-auto');
    clearSearchBtn.classList.add('opacity-0', 'pointer-events-none');
  }
  
  document.getElementById('sort-select').value = 'latest';
  
  currentPage = 1;
  currentFilters = {};
  
  // Load products from backend instead of showing static HTML
  await loadProductsFromBackend({});
  
  showAlert.success('All filters cleared!');
}

      function showLoadingState() {
        const productGrid = document.getElementById('product-grid');
        productGrid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
            <p class="text-gray-600 mt-4">Loading products...</p>
          </div>
        `;
      }

      function showErrorState(message = 'Error loading products') {
        const productGrid = document.getElementById('product-grid');
        productGrid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">${message}</h3>
            <p class="text-gray-500">Please try again later</p>
            <button onclick="loadProductsFromBackend()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
              Retry
            </button>
          </div>
        `;
      }

      window.loadProductsFromBackend = () => loadProductsFromBackend(currentFilters);
      window.clearAllFilters = clearAllFilters;
    });
  </script>
</body>
</html>