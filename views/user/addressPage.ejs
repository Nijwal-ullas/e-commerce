<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Address - Bulk Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        font-family: "Lato", sans-serif;
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <%- include("../partials/user/header.ejs") %>

    <div class="max-w-full mx-auto px-6 lg:px-12 py-8">
      <div class="flex flex-col lg:flex-row gap-8">
        <%- include("../partials/user/profileSidebar.ejs") %>

        <div class="flex-1">
          <div class="bg-gray-100 rounded-lg p-6 lg:p-8">
            <div class="bg-white rounded-lg shadow-sm p-6 lg:p-10">
              <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-medium text-gray-800">Address</h2>
                <a
                  href="/address/add"
                  class="px-6 py-2 rounded-full bg-red-700 text-white text-sm hover:bg-red-800 whitespace-nowrap"
                >
                  + Address
                </a>
              </div>

              <% if (addresses && addresses.length > 0) { %>
              <div class="space-y-4">
                <% addresses.forEach(address => { %>
                <div class="border border-gray-200 rounded-lg p-6">
                  <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3">
                      <input type="radio" name="defaultAddress" value="<%=
                      address._id %>" <%= address.isDefault ? 'checked' : '' %>
                      onchange="setDefaultAddress('<%= address._id %>')"
                      class="mt-1 text-red-600 focus:ring-red-600" >
                      <div>
                        <div class="flex items-center space-x-2 mb-2">
                          <span class="font-medium text-gray-800"
                            ><%= address.name %> [<%= address.addressType
                            %>]</span
                          >
                        </div>
                        <p class="text-gray-600"><%= address.flatNumber %></p>
                        <% if (address.streetName) { %>
                        <p class="text-gray-600"><%= address.streetName %></p>
                        <% } %> <% if (address.landMark) { %>
                        <p class="text-gray-600">
                          Landmark: <%= address.landMark %>
                        </p>
                        <% } %>
                        <p class="text-gray-600">
                          <%= address.city %>, <%= address.state %> <%=
                          address.pincode %>
                        </p>
                        <% if (address.phone) { %>
                        <p class="text-gray-600 mt-2">
                          Phone: <%= address.phone %>
                        </p>
                        <% } %> <% if (address.alternativePhone) { %>
                        <p class="text-gray-600">
                          Alt: <%= address.alternativePhone %>
                        </p>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div
                    class="flex space-x-4 mt-4 pt-4 border-t border-gray-200"
                  >
                    <a
                      href="/address/edit/<%= address._id %>"
                      class="text-red-600 hover:text-red-700 font-medium"
                      >Edit</a
                    >
                    <button
                      onclick="deleteAddress('<%= address._id %>')"
                      class="text-red-600 hover:text-red-700 font-medium"
                    >
                      Delete
                    </button>
                  </div>
                </div>
                <% }); %>
              </div>
              <% } else { %>
              <div class="text-center py-16 text-gray-500">
                <i
                  class="fas fa-map-marker-alt text-5xl mb-4 text-gray-400"
                ></i>
                <p class="text-lg">
                  No addresses found. Add your first address!
                </p>
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include("../partials/user/footer.ejs") %>

    <script>
      function handleLogout() {
        if (confirm("Are you sure you want to logout?")) {
          window.location.href = "/logout";
        }
      }

      function editAddress(id) {
        window.location.href = `/address/edit/${id}`;
      }

      function deleteAddress(id) {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#b91c1c",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/address/delete/${id}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Swal.fire({
                    title: "Deleted!",
                    text: "Your address has been deleted.",
                    icon: "success",
                    confirmButtonColor: "#b91c1c",
                  }).then(() => {
                    location.reload();
                  });
                } else {
                  Swal.fire({
                    title: "Error!",
                    text: "Failed to delete address",
                    icon: "error",
                    confirmButtonColor: "#b91c1c",
                  });
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                Swal.fire({
                  title: "Error!",
                  text: "An error occurred",
                  icon: "error",
                  confirmButtonColor: "#b91c1c",
                });
              });
          }
        });
      }

      function setDefaultAddress(id) {
        fetch(`/address/set-default/${id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                title: "Success!",
                text: "Default address updated",
                icon: "success",
                timer: 1500,
                showConfirmButton: false,
              });
            } else {
              Swal.fire({
                title: "Error!",
                text: "Failed to set default address",
                icon: "error",
                confirmButtonColor: "#b91c1c",
              });
              location.reload();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            Swal.fire({
              title: "Error!",
              text: "An error occurred",
              icon: "error",
              confirmButtonColor: "#b91c1c",
            });
          });
      }
    </script>
  </body>
</html>
